# Release of Canton 3.4.4

Canton 3.4.4 has been released on November 06, 2025.

## What’s New

### External Signing

Externally signed transactions by a party or a wallet is an important feature, which has been improved in the following ways:

- Preparing a transaction for external signing now includes a traffic cost estimate to gauge how much the transaction will cost when executed on the Canton Network. This is an estimate and not a precise traffic cost.
- New endpoints allow to execute a prepared transaction and wait for its result, which simplifies application development and offers now the same functionality as for regular command submission.

### Package Unvetting

When a package is discovered to be faulty or needs to be deprecated for other reasons, the operation to "unvet" a package is now fully supported, such that this package can no longer be used on the ledger.

### Scale and Performance

Many improvements have been delivered to improve scale and performance, including to be able to tune the performance of the system, configure explicit rate limits to prevent overload, improve the ledger api indexing schema, and reduce the size of the topology state.

### New Canton Docker Images

New docker images for Canton nodes are now published to `europe-docker.pkg.dev/da-images/public/docker` and include:
- `canton-participant`: for a participant node
- `canton-mediator`: for a mediator node
- `canton-sequencer`: for a sequencer node
- `canton-base`: a minimal Canton base image without pre-configuration

### Preview Feature

Introduction of a preview Canton feature, for testing purposes, of "logical synchronizer upgrades" (LSU), which reduces downtime and operational complexity for protocol version upgrades, as well as supporting data continuity for history across upgrades. This preview feature is for testing purposes only and should not be run in production (yet).

## Functional Changes

### External Signing / Interactive Submission

- The `PrepareSubmission` endpoint of the `InteractiveSubmissionService` on the Ledger API now returns an estimation
  of the traffic cost that will be incurred by the submitting participant when submitting the transaction to the synchronizer. See the [documentation](https://docs.digitalasset.com/build/3.4/tutorials/app-dev/external_signing_submission.html#traffic-cost-estimation) for details.
- The InteractiveSubmissionService now offers two additional endpoints: `ExecuteSubmissionAndWait` and `ExecuteSubmissionAndWaitForTransaction`. They are synchronous endpoints for the execution of externally signed transactions. Refer to the [API documentation](https://docs.digitalasset.com/build/3.4/reference/lapi-proto-docs.html#executesubmissionandwait-method-version-com-daml-ledger-api-v2-interactive) for details.

### Package upgrading/vetting/unvetting

- The creation package of contracts (the package-id of the contract's template-id) does not need to be vetted anymore
  for the contract to be used in Daml transactions. Instead, it is sufficient that there exists at least a compatible package
  the contract can be up/downgraded to.
- New Ledger API endpoints are added to improve UX of package vetting:

    1. `ListVettedPackages` in `package_service.proto`, to easily list which
       packages are vetted.
    2. `UpdateVettedPackages` in `package_management_service.proto`, to easily vet
       and unvet packages.

- Modify `UploadDarFileRequest` in `package_management_service.proto` to take a
  `vetting_change` attribute, which specifies whether the uploaded DAR should be
  vetted or not.

- Added support for vetting packages on specific synchonizers, by adding an
  optional synchronizer_id field to the following messages:
    - `ValidateDarRequest`, `UploadDarRequest`, `VetDarRequest`, and
      `UnvetDarRequest` in the Canton Admin API (`com.digitalasset.canton.admin.participant.v30.PackageService`)
    - `UploadDarFileRequest`, `ValidateDarFileRequest`, and
      `UpdateVettedPackagesRequest` in the Ledger API
      (`com.daml.ledger.api.v2.admin.PackageManagementService`)
    - These requests no longer use AuthorizedStore for vetting changes, they
      must specify a target synchronizer via the new synchronizer_id fields if
      the target participant is connected to more than one synchronizer.

- Unvetting a package that is used as a dependency by another vetted package now requires `FORCE_FLAG_ALLOW_UNVETTED_DEPENDENCIES`. It should only be used in case there is a problem with the vetted package dependency check being faulty.
- Add `FORCE_FLAG_ALLOW_VET_INCOMPATIBLE_UPGRADES` in topology manager write service. It allows vetting packages that are upgrade incompatible.

### KMS / Crypto

- The GCP KMS driver now supports the `Ed25519` scheme for signing.
- Updated the KMS driver to support the `Ed25519` scheme for signing and `EciesHkdfHmacSha256Aes128Cbc` for encryption. To enable this, the drivers must be recompiled.

### JSON API

- JSON Ledger API is now configured by default. It can be disabled by setting
  ```
  canton.participants.<participant>.http-ledger-api.enabled=false
  ```

- A level of nesting in the Http Ledger API configuration has been eliminated. Now the `address`,
  `port`, `portFile`, `pathPrefix`, as well as `requestTimeout` are set directly on the `http-ledger-api` like so:
  ```
  canton.participants.<participant>.http-ledger-api.port=5555
  ```
  instead of
  ```
  canton.participants.<participant>.http-ledger-api.server.port=5555
  ```
  The old configuration paths continue to be supported in 3.4.0.

### Ledger API / JSON API

- Introduced the ability for the user to self-administer. A user can now
    - query the details of any the party it has any right to operate (ReadAs, ActAs, ExecuteAs or wildcard forms thereof)
      - represented in gRPC Ledger API by `PartyManagementService.getParties`
      - represented in JSON Ledger API by `GET http://localhost:6864/v2/parties/{party-id}`
    - query own user record
      - represented in gRPC Ledger API by `UserManagementService.getUser`
      - represented in JSON Ledger API by `GET http://localhost:6864/v2/users/{user-id}`
    - query own rights
      - represented in gRPC Ledger API by `UserManagementService.listUserRights`
      - represented in JSON Ledger API by `GET http://localhost:6864/v2/users/{user-id}/rights`
    - allocate own party
      - represented in gRPC Ledger API by `PartyManagementService.allocateParty`
      - represented in JSON Ledger API by `POST http://localhost:6864/v2/parties`
- There is a per-participant setting that defines maximum number of access rights that a user can have and still be able to self-allocate a party:
```
canton.participants.<participant-id>.ledger-api.party-management-service.max-self-allocated-parties = 4
```
The default is 0, it means by default a user cannot allocate any parties.
- `GetConnectedSynchronizers` command now can be accessed either with `ReadAs`, `Admin` or `IDPAdmin` permissions. As a
  result, the proto command also now has an optional `identityProviderId` field.
- The HTTP connection timeout is configurable in the Ledger JSON API via
  `canton.participants.<participant-id>.http-ledger-api.server.request-timeout=<duration>`. Configure this value to allow
  more complex Ledger API requests to complete (e.g. `/state/active-contracts`). The default value is 20 seconds.
- Add configuration for the size of the inbound metadata on the Ledger API. Changing this value allows
  the server to accept larger JWT tokens.
  `canton.participants.participant.ledger-api.max-inbound-metadata-size=10240`
- JSON Ledger API: added `authenticated-user` endpoint to get the current user.
- JSON Ledger API: `prefetchContractKeys` added to `JsCommands` and `JsPrepareSubmissionRequest`
- JSON Ledger API: fixed openapi documentation for: `Completion/Completion1` (status property), `ParticipantAuthorizationAdded`, `ParticipantAuthorizationChanged`,`ParticipantAuthorizationRevoked`
- Ledger API: the existing `InteractiveSubmissionService.GetPreferredPackageVersion` (gRPC) or `interactive-submission/preferred-package-version` (JSON) functionality is superseeded by a new endpoint pair:
    - gRPC: `InteractiveSubmissionService.GetPackagePreferences`
    - JSON: `interactive-submission/package-preferences`
      The existing endpoints are deprecated but preserved for backwards compatibility.
- Contract arguments for Created events are now always populated for both LedgerEffects and AcsDelta shaped events if
    - there is a party in the filter that is in the witness parties of the event or
    - a party-wildcard filter is defined.
- Created and exercised events in AcsDelta transactions now include a flag indicating
  whether this event would be part of the respective ACS_DELTA shaped stream, and should therefore be considered
  when tracking contract activeness on the client-side. This way clients with LedgerEffects subscriptions are enabled
  to track contract lifecycle. The Java bindings and the JSON api messages have been extended accordingly.
- Add synchronizer_id to Reassignment Ledger API (gRPC and JSON) message. This aligns the Reassignment with the Transaction messages,
  which also hold this property on top level. This also helps clients to make sense of the record time of this update without
  looking into the events themselves.

### ACS Import/Export

- Adds a new, party replication focused `ExportPartyAcs` endpoint to `party_management_service.proto`. This endpoint
  finds the correct ledger offset (party activation on the target participant) and excludes active contracts from the
  export which have stakeholders that are already hosted on the target participant (contract duplication prevention).
- ParticipantRepairService.ExportAcsOld is deprecated
- Adds the capability to exclude contracts that have some stakeholders in `ExportAcs` and `ImportAcs` endpoints  (`participant_repair_service.proto`).
- The participant node Admin API `PartyManagementService.ImportPartyAcs` endpoint has the request enriched with:
    - the `representative_package_id_override` field which allows overriding the original package id of the imported contracts.
    - the `contract_import_mode` field which allows toggling the contract import mode
      (no validation OR full contract and contract-id validation OR contract-id recomputation) for the imported contracts.

### API Rate Limits

- Sequencer API endpoint `SequencerService.SubscribeV2` has been renamed to `SequencerService.Subscribe`.
- The limit in the config option `canton.sequencers.sequencer.parameters.sequencer-api-limits` has been renamed accordingly:
  `"com.digitalasset.canton.sequencer.api.v30.SequencerService/Subscribe" : 1000`
- Generalised the stream limits into concurrent call limits. Instead of
  `public-api.stream.limits`, we now have `<any-api>.limits.active`, which limits streams
  and requests. This is true for the Ledger API as well. The old stream limit configuration
  of the Ledger API has been removed.

### Performance Tuning

- Added endpoints related to topology snapshots that are less memory intensive for the nodes exporting the topology snapshots:
    - `TopologyManagerReadService.ExportTopologySnapshotV2`: generic topology snapshot export
    - `TopologyManagerReadService.GenesisStateV2`: export genesis state for major upgrade
    - `TopologyManagerWriteService.ImportTopologySnapshotV2`: generic topology snapshot export
    - `SequencerAdministrationService.OnboardingStateV2`: export sequencer snapshot for onboarding a new sequencer
    - `SequencerInitializationService.InitializeSequencerFromGenesisStateV2`: initialize sequencer for a new synchronizer
    - `SequencerInitializationService.InitializeSequencerFromOnboardingStateV2`: initialize sequencer from an onboarding snapshot created by `SequencerAdministrationService.OnboardingStateV2`

- Mediator deduplication store pruning is now much less aggressive:
    - running at most 1 query at a time
    - running at most once every configurable interval:
```hocon
  canton.mediators.<mediator>.deduplication-store.prune-at-most-every = 10s // default value
```
- Mediator deduplication now has batch aggregator configuration exposed for `persist` operation,
  allowing to tune parallelism and batch size under:
```hocon
  canton.mediators.<mediator>.deduplication-store.persist-batching = {
    maximum-in-flight = 2 // default value
    maximum-batch-size = 500 // default value
  }
```
- Add flag to disable the initial topology snapshot validation in case of large topology states. Without validation the hash of the initial topology state is compared from all sequencers.
  ```
  participants.participant1.topology.validate-initial-topology-snapshot = true // default value
  mediators.mediator1.topology.validate-initial-topology-snapshot = true // default value
  sequencers.sequencer1.topology.validate-initial-topology-snapshot = true // default value
  ```
- The package dependency resolver, which is used in various topology state checks and transaction processing is improved as follows:
    - The underlying cache is now configurable via `canton.parameters.general.caching.package-dependency-cache`.
      By default, the cache is size-bounded at 10000 entries and a 15-minutes expiry-after-access eviction policy.
    - The parallelism of the DB package fetch loader used in the package dependency cache
      is bounded by the `canton.parameters.general.batching.parallelism` config parameter, which defaults to 8.
- Deduplication references added to Ledger API DB, giving performance improvement for ACS retrievals in presence of a lot of archived contracts.
    - New participant config parameter `active-contracts-service-streams-config.id-filter-query-parallelism` is added, controlling the
      introduced parallel processing stage filtering IDs (default: 2) during the Ledger API client streaming.
    - New participant config parameter `indexer-config.db-prepare-parallelism` is added, controlling the introduced parallel stage processing
      stage computing deactivation references during indexing.

### Monitoring

- OTLP trace export configuration has been extended with several new parameters allowing connection to OTLP servers,
  which require more elaborate set-up:
    - `trustCollectionPath` should point to a valid CA certificate file. When selected a TLS connection
      is created instead of an open-text one.
    - `additionalHeaders` allows specifying key-value pairs that are added to the HTTP2 headers on all trace exporting
      calls to the OTLP server.
    - `timeout` sets the maximum time to wait for the collector to process an exported batch of spans.
      If unset, defaults to 10s.
    - `connectTimeout` sets the maximum time to wait for new connections to be established. If unset, defaults to 10s.

### Topology Management

- The PartyToParticipant topology mapping has been extended to allow external parties to reference the protocol signing public keys and signing threshold they wish to use to authorize transactions. This effectively replaces the functionality provided by the PartyToKeyMapping, which will therefore be deprecated.
  Additionally, when one of the signing keys in the PartyToParticipant is also the party’s namespace, it can be used to “self-sign” the transaction, removing the need for a separate root NamespaceDelegation registering the party’s root namespace key, and thereby allowing a single topology transaction to onboard an external party.
- Replace an unbounded timeout with a configurable timeout when waiting to observe the submitted topology transactions. A warning is logged when the timeout occurred and the dispatching will be retried.
  Additionally, the delay between retries of the topology dispatching loop has been made configurable.
  ```
  participants.participant1.topology.topology-transaction-observation-timeout = 30s // default value
  participants.participant1.topology.broadcast-retry-delay = 10s // default value

  mediators.mediator1.topology.topology-transaction-observation-timeout = 30s // default value
  mediators.mediator1.topology.broadcast-retry-delay = 10s // default value

  sequencers.sequencer1.topology.topology-transaction-observation-timeout = 30s // default value
  sequencers.sequencer1.topology.broadcast-retry-delay = 10s // default value
  ```
- The topology outbox now supports backpressure. This means that topology requests will start to be rejected
  if the topology outbox is full. The size of the outbox can be configured via
  ```canton.<type>.<name>.topology.max-unsent-topology-queue-size = 100 (default)```

### Sequencer connections
- The new sequencer connection pool is enabled by default. The following flag can be set to `false` in order to
  revert to the old transport mechanism:
```hocon
    canton.participants.<participant>.sequencer-client.use-new-connection-pool = false
    canton.mediators.<mediator>.sequencer-client.use-new-connection-pool = false
    canton.sequencers.<sequencer>.sequencer-client.use-new-connection-pool = false
```
- Setting the following flag (default: `false`) for a node enables some improvements in the amplification behavior:
   - When sending a submission request with amplification, if we receive a synchronous error from
     the sequencer that is classified as `RequestRefused`, we abort amplification and bubble up
     the error to the caller. If this flag is set, in the specific case of a sequencer refusing the submission
     because it is overloaded ([[com.digitalasset.canton.sequencing.protocol.SequencerErrors.Overloaded]]),
     we will immediately continue to the next step of amplification.
   - Scheduling of the next amplification takes into account the time taken by the transport to
     provide a response.
```hocon
    canton.participants.<participant>.sequencer-client.enable-amplification-improvements = true
    canton.mediators.<mediator>.sequencer-client.enable-amplification-improvements = true
```

## Breaking Changes

### External Signing / Interactive Submission

The new party allocation endpoints above come with a breaking change for users of the gRPC `InteractiveSubmissionService` used in external signing workflows. The following protobuf messages have been refactored to a new common protobuf package so they can be re-used across different services:

| Old file                                                                | Old FQN                                                 | New file                            | New FQN                                     |
|-------------------------------------------------------------------------|---------------------------------------------------------|-------------------------------------|---------------------------------------------|
| com/daml/ledger/api/v2/interactive/interactive_submission_service.proto | com.daml.ledger.api.v2.interactive.Signature            | com/daml/ledger/api/v2/crypto.proto | com.daml.ledger.api.v2.Signature            |
| com/daml/ledger/api/v2/interactive/interactive_submission_service.proto | com.daml.ledger.api.v2.interactive.SigningAlgorithmSpec | com/daml/ledger/api/v2/crypto.proto | com.daml.ledger.api.v2.SigningAlgorithmSpec |
| com/daml/ledger/api/v2/interactive/interactive_submission_service.proto | com.daml.ledger.api.v2.interactive.SignatureFormat      | com/daml/ledger/api/v2/crypto.proto | com.daml.ledger.api.v2.SignatureFormat      |

To consume the update, re-generate any client code generated from the protobuf definitions and update the package names accordingly in your application code.

Submission time is now called preparation time:
  - The field `submission_time` for interactive submissions is now called `preparation_time`.
  - The dynamic domain parameter `submission_time_record_time_tolerance` is now called `preparation_time_record_time_tolerance`.
  - The error codes `LOCAL_VERDICT_SUBMISSION_TIME_OUT_OF_BOUND` and `TOPOLOGY_INCREASE_OF_SUBMISSION_TIME_TOLERANCE` are now called `LOCAL_VERDICT_PREPARATION_TIME_OUT_OF_BOUND` and `TOPOLOGY_INCREASE_OF_PREPARATION_TIME_TOLERANCE`.
  - The console commands `set_submission_time_record_time_tolerance` is now called `set_preparation_time_record_time_tolerance`.

### Per-synchronizer party allocation

Console commands and API endpoints for allocating/enabling parties now operate on a per-synchronizer basis.
This means that party allocations must be done explicitly for each synchronizer, and that the participant
must be connected to each synchronizer at the time of enabling the party.

The console commands `participant.parties.enable` and `participant.parties.disable` have a new parameter `synchronizer: Option[SynchronizerAlias]`
that specifies on which synchronizer the party should be enabled or disabled. The parameter can be "omitted" or set to `None`, if the participant
is connected to only one synchronizer. The parameter `waitForSynchronizer: SynchronizerChoice` has been removed.

The console command `participant.ledger_api.parties.allocate` has a new parameter `synchronizer_id` for specifying the target synchronizer for the party allocation.
Similar to the parameter for the other console commands, this parameter can be omitted if the participant is connected to only one synchronizer.

The Ledger API request `PartyManagementService.AllocatePartyRequest` now has a new field `string synchronizer_id` for specifying the target synchronizer of the party allocation.
Similar to the parameter for the console commands, this parameter can be omitted if the participant is connected to only a one synchronizer.

If the synchronizer parameter is not specified and the participant is connected to multiple synchronizers, the request fails with the error `PARTY_ALLOCATION_CANNOT_DETERMINE_SYNCHRONIZER`.
If the participant is not connected to any synchronizer, the request fails with the error `PARTY_ALLOCATION_WITHOUT_CONNECTED_SYNCHRONIZER`.

The authorized store can still be used to store `PartyToParticipant` topology transactions, but users are discouraged from doing so.

### Synchronizer ID

In order to support logical synchronizer upgrades, console commands and admin API endpoints now need to distinguish between logical and physical synchronizer ids:

- Changed the protobuf definition of the admin API `StoreId.Synchronizer` from just having a `string id` field to the following:
```
    message Synchronizer {
      oneof kind {
        string logical = 1;
        string physical = 2;
      }
    }
```
- Some console commands now take `TopologyStoreId.Synchronizer` instead of `SynchronizerId` as parameter.
  This should be non-breaking,because there are implicit conversions from `SynchronizerId` and `PhysicalSynchronizerId` to `TopologyStoreId.Synchronizer`.

- The `synchronizers.id_of` console command returns now the `SynchronizerId` instead of a `PhysicalSynchronizerId`. Another command `synchronizers.physical_id_of` has been added to return the `PhysicalSynchronizerId`.

Protobuf changes:
- SynchronizerConnectivityService.GetSynchronizerIdResponse.synchronizer_id changed to physical_synchronizer_id
- SequencerConnectService.GetSynchronizerIdResponse.synchronizer_id changed to physical_synchronizer_id
- MediatorStatusService.MediatorStatusResponse.MediatorStatusResponseStatus.synchronizer_id changed to physical_synchronizer_id
- SequencerStatusService.SequencerStatusResponse.SequencerStatusResponseStatus.synchronizer_id changed to physical_synchronizer_id
- ListConnectedSynchronizersResult.synchronizerId renamed to physicalSynchronizerId

### Crypto

- We have removed support for `ecies-hkdf-hmac-sha-256-aes-128-gcm` encryption algorithm specification. Use `ecies-hkdf-hmac-sha-256-aes-128-cbc` instead.
- The number of keys per node or external party are not restricted to a maximum of 20 keys.

### Topology Management

- Upgrades of participant permissions in the `PartyToParticipant` mapping now require the authorization of both the party and respective participant. For backwards compatibility, existing transactions in the genesis block do NOT require the authorization of participants for permission upgrades.
- The console commands for OwnerToKeyMapping and PartyToKeyMapping have been changed to accept the factory method parameters instead of OTK and PTK values directly. This is in line with the `propose` methods for other mappings as well.
- Synchronizer owners are implicitly authorized to REMOVE any topology transaction on the synchronizer, even if they are not the "normal" authorizers. As a consequence, the unused topology mapping `PurgeTopologyTransaction` has been removed from the code base.
- Committed `NamespaceDelegation` transactions with the `Remove` operations cannot be re-created with a `Replace` operation anymore.
- Upgrades of participant permissions in the `PartyToParticipant` mapping now require the authorization of both the party and respective participant.
  For backwards compatibility, existing transactions in the genesis block do NOT require the authorization of participants for permission upgrades.

### Package vetting

- Removed force flag `FORCE_FLAG_ALLOW_UNVET_PACKAGE` and topology manager error `TOPOLOGY_DANGEROUS_VETTING_COMMAND_REQUIRES_FORCE_FLAG`.
  Unvetting a package is not a dangerous operation anymore.
- Removed force flag `FORCE_FLAG_ALLOW_UNVET_PACKAGE_WITH_ACTIVE_CONTRACTS`.
  Unvetting a package-id referenced by an active contract is not dangerous anymore provided there's another compatible package vetted (the same package-name but with a higher package-version than the unvetted package).
- The VettedPackage validFrom and validUntil fields have been renamed to validFromInclusive and validFromExclusive.
- Package upgrade validation moved to vetting state change.
  Thus uploading an upgrade-incompatible DAR with vetting disabled is now possible.
  Related error codes changed:
    - `DAR_NOT_VALID_UPGRADE` is renamed `NOT_VALID_UPGRADE_PACKAGE`
    - `KNOWN_DAR_VERSION` is renamed `KNOWN_PACKAGE_VERSION`

### Ledger API / JSON API

- The legacy gRPC Ledger API method `CommandService.SubmitAndWaitForTransactionTree` has been removed. The JSON version of this request `/v2/commands/submit-and-wait-for-transaction-tree` continues to be supported in 3.4 (marked as depreated), but will be removed in 3.5.
- The legacy gRPC Ledger API methods in the `UpdateService` have been removed.
    - `GetUpdateTrees`
    - `GetTransactionTreeByOffset`
    - `GetTransactionTreeById`
    - `GetTransactionByOffset`
    - `GetTransactionById`
- The JSON versions of the removed `UpdateService` requests continue to be supported in 3.4 (marked as deprecated), but will be removed in 3.5.
    - `/v2/updates/trees`
    - `/v2/updates/transaction-tree-by-offset`
    - `/v2/updates/transaction-tree-by-id`
    - `/v2/updates/transaction-by-offset`
    - `/v2/updates/transaction-by-id`

- The legacy gRPC Ledger API message `TransactionFilter` has been removed. As a consequence, the `filter` and `verbose` fields
  have been dropped from the `GetUpdatesRequest` and `GetActiveContractsRequest` messages.
- The JSON versions of the above gRPC messages **continue to be supported in their old form 3.4**.
  They will be removed and altered respectively 3.5. This affects:
    - `TransactionFilter` will be removed in 3.5
    - `GetUpdatesRequest` will be altered in 3.5, it is used in
        - `/v2/updates` HTTP POST and websocket GET endpoints
        - `/v2/updates/flats` HTTP POST and websocket GET endpoints
        - `/v2/updates/trees` HTTP POST and websocket GET endpoints
    - `GetActiveContractsRequest` will be altered in 3.5, it is used in
        - `/v2/state/active-contracts` HTTP POST and websocket GET endpoints
- The configuration for the removed Ledger API transaction tree stream related methods have been removed as well
  ```
  canton.participants.<participant>.ledger-api.index-service.transaction-tree-streams.*
  ```
- The console commands `ledger_api.users.rights.grant` and `ledger_api.users.rights.revoke`
  have been changed to return the complete state of current rights assigned to a user instead of
  the "delta" induced by the command.
- Authorization of the calls made by the IDP Admins has been tightened. It is no longer possible for them to grant
  rights to parties which are in other IDPs or in no IDP. This effectively enforces keeping the IDP Admins within
  their respective IDP boxes. Participant Admins can still grant the rights that cross the IDP box boundaries e.g.
  A User in IDP A can be given right to a party IDP B.
- The SubscribeTrees and SubscribeFlat LedgerApiCommands were removed. The SubscribeUpdates should be used instead.
- The SubmitAndWaitTransactionTree LedgerApiCommand was removed. The SubmitAndWaitTransaction should be used instead.
- The GetTransactionById and GetTransactionByOffset LedgerApiCommands were removed. The GetUpdateById should be used instead.
- The following canton console commands have been removed:
    - ledger_api.updates.{trees, flat}
    - ledger_api.updates.{trees_with_tx_filter, flat_with_tx_filter}
    - ledger_api.updates.{subscribe_trees, subscribe_flat}
    - ledger_api.updates.{by_id, by_offset}
    - ledger_api.commands.submit_flat
    - ledger_api.javaapi.updates.{trees, flat}
    - ledger_api.javaapi.updates.flat_with_tx_filter
    - ledger_api.javaapi.commands.submit_flat
- The following canton console commands have been added:
    - ledger_api.updates.updates
    - ledger_api.updates.{transactions, reassignments, topology_transactions}
    - ledger_api.updates.transactions_with_tx_format
    - ledger_api.updates.subscribe_updates
    - ledger_api.javaapi.updates.transactions
    - ledger_api.javaapi.updates.transactions_with_tx_format
- For more info on how to migrate follow the migration guide (console-commands-migration-guide.rst)
- Participant configuration and metrics changes because of major changes in Ledger API Index DB schema:
    - `UpdatesStreamsConfig` is adapted to the new table structure, and respective streaming parameters changed:
        - Configuration parameters controlling parallelism of streaming ID retrieval for the legacy DB tables are removed:
            - `maxParallelIdCreateQueries`
            - `maxParallelIdConsumingQueries`
            - `maxParallelIdNonConsumingQueries`
            - `maxParallelIdAssignQueries`
            - `maxParallelIdUnassignQueries`
        - Configuration parameters controlling parallelism of streaming ID retrieval for the new DB tables are added:
            - `maxParallelIdActivateQueries`
            - `maxParallelIdDeactivateQueries`
            - `maxParallelIdVariousWitnessedQueries`
        - Configuration parameters controlling parallelism of streaming Payload retrievals for the legacy DB tables are removed:
            - `maxParallelPayloadCreateQueries`
            - `maxParallelPayloadConsumingQueries`
            - `maxParallelPayloadNonConsumingQueries`
            - `maxParallelPayloadAssignQueries`
            - `maxParallelPayloadUnassignQueries`
        - Configuration parameters controlling parallelism of streaming Payload retrievals for the new DB tables are added:
            - `maxParallelPayloadActivateQueries`
            - `maxParallelPayloadDeactivateQueries`
            - `maxParallelPayloadVariousWitnessedQueries`
    - `IndexDBMetrics` is adapted to the new table structure, and respective DB metrics changed:
        - Metrics for DB queries related to legacy DB tables are removed:
            - `fetch_event_create_payloads`
            - `fetch_event_consuming_payloads`
            - `fetch_event_non_consuming_payloads`
            - `fetch_event_assign_payloads`
            - `fetch_event_unassign_payloads`
            - `fetch_event_create_ids_stakeholder`
            - `fetch_event_create_ids_non_stakeholder`
            - `fetch_event_consuming_ids_stakeholder`
            - `fetch_event_consuming_ids_non_stakeholder`
            - `fetch_event_non_consuming_ids_informee`
            - `fetch_event_assign_ids_stakeholder`
            - `fetch_event_unassign_ids_stakeholder`
            - `lookup_assigned_contracts`
            - `lookup_archived_contracts`
            - `lookup_transaction_tree_by_id`
            - `get_active_contract_id_ranges_for_created`
            - `get_active_contract_id_ranges_for_assigned`
            - `get_active_contract_batch_for_created`
            - `get_active_contract_batch_for_assigned`
            - `get_create_ids_for_contract_ids`
            - `get_assign_ids_for_contract_ids`
            - `archivals`
        - Metrics for DB queries related to the new DB tables are added:
            - `fetch_event_activate_payloads`
            - `fetch_event_deactivate_payloads`
            - `fetch_event_various_witnessed_payloads`
            - `fetch_event_activate_ids_stakeholder`
            - `fetch_event_activate_ids_stakeholder_filtered_range`
            - `fetch_event_activate_ids_stakeholder_filtered_ids`
            - `fetch_event_activate_ids_witness`
            - `fetch_event_activate_ids_witness_filtered_range`
            - `fetch_event_activate_ids_witness_filtered_ids`
            - `fetch_event_deactivate_ids_stakeholder`
            - `fetch_event_deactivate_ids_stakeholder_filtered_range`
            - `fetch_event_deactivate_ids_stakeholder_filtered_ids`
            - `fetch_event_deactivate_ids_witness`
            - `fetch_event_deactivate_ids_witness_filtered_range`
            - `fetch_event_deactivate_ids_witness_filtered_ids`
            - `fetch_event_various_ids_witness`
            - `lookup_active_contracts`
            - `get_active_contracts`
            - `get_active_contract_id_ranges`
            - `get_filtered_active_contract_ids`
            - `get_active_contract_batch`
            - `pruneable_contracts`
- `PackageManagementService.UpdateVettedPackages` request is extended with the `UPDATE_VETTED_PACKAGES_FORCE_FLAG_ALLOW_VET_INCOMPATIBLE_UPGRADES`
  force flag to allow vetting packages that are upgrade incompatible. This should only be used in very rare cases where the upgrade check incorrectly fails and generally should not be used in combination with contracts already created in Canton 3.3.
- `PackageManagementService.UpdateVettedPackages` request is extended with the `UPDATE_VETTED_PACKAGES_FORCE_FLAG_ALLOW_UNVETTED_DEPENDENCIES`
  force flag to allow vetting packages without vetting one or more of their dependencies.
- JSON API - changed encoding for protobuf based enums.
  Following types are now encoded as strings:
    - `HashingSchemeVersion`,
    - `PackageStatus`,
    - `ParticipantPermission`,
    - `SigningAlgorithmSpec`,
    - `SignatureFormat`,
    - `TransactionShape`,
- The default security configuration of the APIs has been tightened
    - Maximum token lifetime accepted by the Ledger API (gRPC and JSON) and Admin API has been reduced. Tokens which have
      time to live longer than 5 minutes will not be accepted. This default value can be overridden through
      ```
      canton.participants.<participant>.ledger-api.max-token-lifetime=10.minutes
      ```
      and
      ```
      canton.participants.<participant>.admin-api.max-token-lifetime=10.minutes
      ```
      You can also turn the mechanism off completely by setting the value to `Inf`.
    - The JWKS cache expiration has been reduced to 5 minutes. A JWKS key will be evicted from the cache after that time and
      the participant will access the JWKS address again to pull the fresh keys. You can modify this behavior by setting
      ```
      canton.participants.<participant>.ledger-api.jwks-cache-config.cache-expiration=10.minutes
      ```
      and
      ```
      canton.participants.<participant>.admin-api.jwks-cache-config.cache-expiration=10.minutes
      ```
    - By default, the Canton Admin Tokens no longer entitle the bearer to operate as a `ParticipantAdmin` nor to `ActAs` any party.
      This behavior can be altered by setting
      ```
      canton.participants.<participant>.ledger-api.admin-token-config.act-as-any-party-claim=true
      canton.participants.<participant>.ledger-api.admin-token-config.admin-claim=true
      ```
- Introduced `/dars/validate` JSON API endpoint to validate DAR files without uploading them, mirroring
  the gRPC `PackageManagementService.ValidateDarFile` endpoint.
  As part of this, also aliased POST `packages` (for DAR upload) to POST `dars`.
- Corrected HTTP method for the JSON Ledger API endpoint `interactive-submission/preferred-packages` from GET to POST.
- The configuration for the admin-token based authorization has changed.

  Previously, the setting of the admin token string was possible through Ledger API or Admin API configuration like so:

  ```
  -C canton.participants.<participant-id>.ledger-api.admin-token="<your-token>"
  or
  -C canton.participants.<participant-id>.admin-api.admin-token="<your-token>"
  ```

  Now, it is set through

  ```
  -C canton.participants.<participant-id>.ledger-api.admin-token-config.fixed-admin-token="<your-token>"
  or
  -C canton.participants.<participant-id>.admin-api.admin-token-config.fixed-admin-token="<your-token>"
  ```

  Other parameters of the admin token can also be set through the `AdminTokenConfig` configuration case class as seen below:

  ```
  final case class AdminTokenConfig(
    fixedAdminToken: Option[String] = None,
    adminTokenDuration: PositiveFiniteDuration = AdminTokenConfig.DefaultAdminTokenDuration,
    actAsAnyPartyClaim: Boolean = true,
    adminClaim: Boolean = true,
  )
  ```

  The `fixedAdminToken` as `adminToken` did before, defines a token that is valid throughout the entire canton process
  lifespan. It is only meant for testing purposes and should not be used in production.

  Other admin-tokens will be generated and rotated periodically for internal usage (e.g. in the console).
  They are invisible from the outside. Each admin-token of these is valid for the defined `adminTokenDuration`.
  The half of the token duration is used as the rotation interval, after which a new admin-token is generated
  (if needed) and used. The default value for the token duration is 5 minutes.

  Setting the `actAsAnyPartyClaim` to `true` allows usage of the admin-token to authorize acting-as and reading-as
  any party in the participant. Similarly, setting the `adminClaim` to `true` allows usage of the admin-token to
  authorize any admin level operation in the participant. As setting these parameters to `true` is consistent with
  the past system behavior, it is the default value for now. We are planning to change them both to `false` in the
  3.4 release to increase default system security. When that happens, the admin-token by default will only be strong
  enough to issue pings.
- Previously, ledger API queries using filters allowed interface or template identifiers to be defined in either
  `package-name` or `package-id` format within the event format (specifically, via the `package_id` field in the `Identifier`
  message of `InterfaceFilter` and `TemplateFilter` in `CumulativeFilter`).
  However, the `package-id` format is now deprecated and will be removed in future releases. A warning message will be
  logged if it is used, as the system internally converts it to the corresponding `package-name` format and resolves
  the query by `package-name` and not by `package-id`.
- All JSON API v1 endpoints `/v1/*` have been removed.
- Removed the deprecated requesting_parties field from the `GetEventsByContractIdRequest` message in the
  Ledger API. Clients should use the `event_format` field instead, as described in lapi-migration-guide.
- In non-verbose mode event rendering of Ledger API queries, trailing Optional record field that are not populated
  are no longer included in the Record representation. The reason for this is so that the same structural representation
  is produced independently of the package version that was used to enrich it.
- In verbose mode reporting, record values will no longer contain trailing Optional fields that
  have a value of [None](https://docs.daml.com/daml/stdlib/Prelude.html#type-da-internal-prelude-optional-37153).
  The reason for this is so that the same structural representation is produced independently of the
  package version that was used to enrich it.
- Canton console - ledger_api changed slightly:
    - `submit_assign`, `submit_unassign` and `submit_reassign` changed: the waitForParticipants removed as these
      endpoints now use the same synchronization mechanics as the transaction submission endpoints. Also the timeout
      field became optional: allowing to bypass synchronization if needed.
    - `submit_assign` and `submit_unassign` have the eventFormat parameter removed, and `submit_assign_with_format`
      and `submit_unassign_with_format` endpoints introduced to provide full functionality with the compromise that the
      result can be empty.

- A default value is provided for the ``transaction_format`` field inside of ``SubmitAndWaitForTransactionRequest``.
  You can now omit this field in both grpc and json requests, and get behavior consistent with the 3.2 version of
  Canton. This means you will receive a flat transaction with event visibility dictated by all ``act_as`` and ``read_as`` parties.
- JSON - changes in openapi (`Any` renamed as `ProtoAny`, `Event1` renamed to `TopologyEvent` and fixed, fixed `Field`, `FieldMask`,`JsReassignmentEvent` mappings.
- Transactions with transient events for which there was an intersection between submitters
  and querying parties were previously exposed as transactions with empty events in AcsDelta shape. Those transactions
  will no longer be exposed at all in the AcsDelta shape. As before, they will still be exposed in the LedgerEffects
  shape.
- Participant divulgence (i.e. if there is a party divulgence, and none of the stakeholders of the divulged contracts
  are hosted on the participant) is no longer performed in Active Contracts Service and AcsDelta transaction shapes.
- `DisclosedContract.template_id` and `DisclosedContract.contract_id` for Ledger API commands
  are not required anymore. When provided, the fields are used for validation of the analogous fields in the encoded created event blob.
- gRPC and JSON API payloads for create events (create arguments, interface views and keys) are now
  rendered using the normal form of the types defined in `CreatedEvent.representative_package_id`.
  This should be transparent on the returned values, with the exception of the record-ids in Ledger API verbose
  rendering (`verbose = true`) which now effectively reflect the representative package id as well.

### Synchronizer Parameters

- Setting DynamicSynchronizerParameters.participantResponseTimeout and mediatorReactionTimeout outside of the interval `[1s, 5min]` requires force flag.
- `topologyChangeDelay` has been moved from `DynamicSynchronizerParameters` to `StaticSynchronizerParameters` and cannot be changed on a physical synchronizer.

### ACS Import/Export

- `ParticipantRepairService.ImportAcs` is updated:
    - The `ImportAcsRequest.contract_id_suffix_recomputation_mode` is renamed to `ImportAcsRequest.contract_import_mode`
      and `ContractIdSuffixRecomputationMode` enum is renamed to `ImportAcsRequest.ContractImportMode` to better reflect its purpose.
      Upon import, contracts can be fully validated (including contract-id suffix recomputation).
    - `ImportAcsRequest.representative_package_id_override` is introduced to allow overriding the original package id of the imported contracts.
      This allows the target participant to use a compatible alternative package for the contract
      without needing to upload original contracts packages.
- Moves general, LAPI active contract based, `ExportAcs` endpoint from `party_management_service.proto`
  to `participant_repair_service.proto`. Note that endpoint does not return retriable error(s) since ACS export is
  defined by the ledger offset.
- Removed `contractSynchronizerRenames` on ACS import legacy.


### Minor Breaking Changes

- Ports for (admin, gRPC Ledger, JSON Ledger, public) API have to be provided explicitly
  (they are not generated automatically anymore.)
- Renamed command `bootstrap.local()` to `bootstrap.synchronizer_local()`. It provides a simple way to bootstrap a local synchronizer.
- The error code `ABORTED_DUE_TO_SHUTDOWN` is now used instead of the (duplicate) error code `SERVER_IS_SHUTTING_DOWN` that was previously used.
- The `SequencerConnections` protobuf structure takes a new parameter `sequencer_liveness_margin` that
  determines the number of extra subscriptions to maintain beyond `sequencer_trust_threshold` in order to ensure
  liveness. This parameter is only used when the new sequencer connection pool is enabled, and is ignored otherwise.
- The `SequencerConnections` class' public constructor `many(...)` takes accordingly a new parameter
  `sequencerLivenessMargin`.
- Config `canton.sequencers.<sequencer>.sequencer.block.reader.use-recipients-table-for-reads = true` has been removed,
  `sequencer_event_recipients` table is now always used for reading from the sequencer via subscriptions.
- Config `canton.sequencers.<sequencer>.sequencer.block.writer.buffer-events-with-payloads = false // default` has been removed,
  events are always buffered without payloads now (payloads are cached separately).
- Config `canton.sequencers.<sequencer>.sequencer.block.writer.buffer-payloads = true // default` has been removed,
  payloads are always handed off to the cache now.
- The console command `connect_local_bft` takes now a list of `SequencerReference` instead of a `NonEmpty[Map[SequencerAlias, SequencerReference]]`
- Renamed mediator scan to mediator inspection for both the commands and the admin API service. Renamed the inspection service gRPC of the participant into ParticipantInspectionService to differentiate from the mediator one.
- Renamed `AuthenticationTokenManagerConfig#pauseRetries` to `minRetryInterval`.
- Endpoints and console commands LocatePruningTimestamp are renamed to FindPruningTimestamp.
- The previous `sequencer-client.amplify-sends-on-overloaded-error` config flag was renamed to `enable-amplification-improvements` and covers both amplification improvements described above.

## Compatibility

The following Canton protocol versions are supported:

| Dependency                 | Version                    |
|----------------------------|----------------------------|
| Canton protocol versions   | 34          |

Canton has been tested against the following versions of its dependencies:

| Dependency                 | Version                    |
|----------------------------|----------------------------|
| Java Runtime               | OpenJDK 64-Bit Server VM (build 21.0.5+1-nixos, mixed mode, sharing)               |
| Postgres                   | Recommended: PostgreSQL 17.6 (Debian 17.6-2.pgdg13+1) – Also tested: PostgreSQL 14.19 (Debian 14.19-1.pgdg13+1), PostgreSQL 15.14 (Debian 15.14-1.pgdg13+1), PostgreSQL 16.10 (Debian 16.10-1.pgdg13+1)           |

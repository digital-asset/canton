..
   Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
..
   SPDX-License-Identifier: Apache-2.0

.. _rotate_wrapper_key:

Rotate the envelope wrapper key
===============================

Some KMS providers (e.g., AWS) offer automatic rotation of symmetric KMS keys (typically yearly).
Canton extends this by allowing node administrators to manually rotate the KMS wrapper key.

.. note::
   You can change the key specification (e.g., enabling multi-region in AWS) during rotation
   by updating the configuration before rotating the wrapper key.

Key rotation does not delete the previous key. While the old key becomes inactive, it is still persisted.
To permanently delete the previous key, see :ref:`Delete Canton node keys <deleting-canton-keys>`.

Rotate with an auto-generated key
---------------------------------

Use the following command:

.. literalinclude:: CANTON/community/app/src/test/scala/com/digitalasset/canton/integration/tests/security/kms/RotateWrapperKeyIntegrationTest.scala
   :language: scala
   :start-after: user-manual-entry-begin: WrapperKeyRotationWithAutoGeneratedKey
   :end-before: user-manual-entry-end: WrapperKeyRotationWithAutoGeneratedKey
   :dedent:

Canton will automatically create a new wrapper key using the configured KMS.

Rotate with a manually generated key
------------------------------------

First, you must create a new wrapper key in your KMS that meets the requirements described :ref:`here <wrapper_key_requirements>`.
Afterwards, you can rotate to that key using the following command:

.. literalinclude:: CANTON/community/app/src/test/scala/com/digitalasset/canton/integration/tests/security/kms/RotateWrapperKeyIntegrationTest.scala
   :language: scala
   :start-after: user-manual-entry-begin: WrapperKeyRotationWithManuallyGeneratedKey
   :end-before: user-manual-entry-end: WrapperKeyRotationWithManuallyGeneratedKey
   :dedent:

- `newWrapperKeyId`: the identifier of the wrapper key you want to rotate to.

